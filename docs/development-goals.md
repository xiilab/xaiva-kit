## 개발 목표 (1차)

### 1. 범위 및 전제
- 대상 플랫폼은 Ubuntu/Linux 22.04로 고정한다.
- 완전 오프라인(에어갭) 환경에서도 빌드가 성공해야 한다.
- 프리셋별로 CUDA 베이스 이미지는 바뀔 수 있으나 OS 버전은 22.04를 유지한다.
- 민감한 토큰/키는 `.env` 파일로 관리하며 프로젝트 폴더와 함께 이동한다.

### 2. 아티팩트 및 의존성 관리
- 로컬 `artifacts/` 디렉터리에 프리셋별로 미러, wheelhouse, tarball, `.deb` 등을 보관한다.
- **디렉터리 구조**: `artifacts/<preset-name>/` 형태로 관리 (예: `artifacts/ubuntu22.04-cuda11.8-torch2.1/`)
  - `wheels/`: Python .whl 파일
  - `debs/`: apt .deb 패키지 (선택 사항)
  - `sources/`: 소스 코드 아카이브 (FFmpeg, OpenCV 등)
  - `requirements.txt`: 해당 프리셋의 Python 패키지 목록
- 인터넷이 가능할 때 사전 다운로드하는 동기화 스크립트(`deps_sync.sh <preset-name>`)를 제공한다.
- Dockerfile은 로컬 아티팩트만 소비하며 `docker build` 중 네트워크 호출을 하지 않는다.
- 프리셋별 APT 패키지, 소스 아카이브 목록을 JSON 메타데이터(`presets/<preset-name>.json`)로 관리한다.
- **현장 복제 시 필요한 프리셋의 `artifacts/<preset-name>/` 폴더만 선택적으로 복사하여 스토리지를 절약한다.**

### 3. 빌드 시스템 요구사항
- 단일 멀티스테이지 Dockerfile에서 다음을 선택해서 생성한다:
  - `builder` 스테이지: 컴파일 툴체인과 소스를 포함하며 개발 이미지로 재사용 가능.
  - `runtime` 스테이지: 최소 의존성 + 빌드 산출물만 포함.
- **대화형 빌드 드라이버는 Python 3 (표준 라이브러리 한정)로 선정한다.**
  - **선정 이유**: Ubuntu 22.04에 기본 내장되어 별도 설치가 필요 없으며, 복잡한 프리셋 데이터(JSON/Dictionary) 처리와 대화형 인터페이스(Input/Select) 구현, 유지보수성 측면에서 Shell Script보다 월등히 유리함.
  - 기능: CLI 플래그(`--preset`, `--base`, `--non-interactive`) 지원 및 프롬프트 모드.
- 프리셋은 별도 파일(JSON)에서 로딩하며, 환경을 설명하는 프리셋 이름 형식(예: `ubuntu22.04-cuda11.8-torch2.1`)을 채택한다.
- 환경 변수 오버라이드를 허용하되 기본값 위주로 사용한다.

### 4. 대화형 빌드 시나리오 (입력 순서)
`python build.py` 실행 시 사용자는 다음 순서로 빌드 옵션을 선택한다.

1.  **프리셋/수동 선택**: 미리 정의된 프리셋을 사용할지, 개별 버전을 수동으로 선택할지 결정.
2.  **베이스 이미지 (CUDA/cuDNN)**: 타겟 GPU 환경에 맞는 CUDA 버전 선택 (예: 11.8, 12.1).
3.  **Python 버전**: 사용할 Python 런타임 버전 선택.
4.  **PyTorch 버전**: AI 모델 호환성에 맞는 PyTorch 버전 선택 (별도 속성으로 관리).
5.  **TensorRT 버전**: 추론 가속을 위한 TensorRT 버전 선택 (또는 미설치).
6.  **빌드 타입**: `Runtime`(배포용, 최소화) 또는 `Dev`(개발용, 소스 포함) 선택.

### 5. 버전 관리 대상 패키지
프리셋 및 대화형 빌드에서 관리해야 할 주요 패키지와 특징은 다음과 같다.

#### A. 인프라 및 베이스
- **CUDA/cuDNN**: Docker Base Image 태그로 결정됨.
- **Python**: `update-alternatives`를 통해 시스템 기본 Python으로 설정.

#### B. 핵심 AI 라이브러리
- **PyTorch**: `torch`, `torchvision`, `torchaudio` 세트 구성 (프리셋 내 별도 속성으로 관리).
- **TensorRT**: `.deb` 또는 `.tar` 기반 설치. **런타임 이미지에 필수 포함** (추론 가속용).
  - 버전 8.x: CUDA 11.8 호환
  - 버전 10.x: CUDA 12.x 호환
- **기타 Python 패키지**: `requirements.txt`에 명시하고 로컬 wheel 파일로 설치.

#### C. 멀티미디어 프레임워크 (소스 빌드)
- **FFmpeg**: 버전(예: `4.2`, `5.1`) 및 빌드 플래그(코덱, 가속 옵션).
- **OpenCV**: 버전(예: `4.9.0`) 및 CUDA/DNN 모듈 활성화 여부.

#### D. 애플리케이션 패키지 (소스 빌드 필수)
- **Xaiva Media**: `.deb` 패키지를 사용하지 않고, **매번 원격/로컬 소스 코드를 빌드하여 설치**한다.
- 소스 관리 방식: Git 서브트리, 외부 경로 마운트, 또는 빌드 컨텍스트에 포함된 소스를 사용한다.
- **직접 클론하지 않음**: 빌드 스크립트가 GitHub 토큰을 사용해 저장소를 직접 클론하지 않으며, 사용자가 사전에 준비한 소스 경로를 참조한다.

### 6. 보안 및 시크릿
- 이미지를 빌드할 때 `.env` 파일에서 토큰(GitHub PAT 등)을 불러온다.
- **현재는 GitHub 토큰만 사용하며, 추후 Docker Registry 인증 등으로 확장 예정이다.**
- 빌드 스크립트는 `.env`를 읽어 필요한 경우에만 `--build-arg`로 전달한다.
- `.env.template` 파일을 제공하여 필요한 환경 변수 목록을 명시한다.
- 현장 팀을 위해 `.env` 복사/삭제 절차를 문서화한다.

### 7. 문서화 및 도구
- `docs/build-guide.md`: 전체 워크플로, 아티팩트 준비, 프리셋, 오프라인 체크리스트.
- `docs/package-versions.md`: 버전 관리를 해야 하는 패키지·의존성·소스 목록을 명시하고 주기적으로 갱신한다.
- `scripts/build.py --help`: 자동 생성되는 CLI 사용 설명서.
- (선택) 빌드 전 아티팩트 체크섬을 검증하는 검증 파이프라인을 제공한다.
- 프리셋별 디렉터리 구조(`artifacts/<preset-name>/`)를 통해 현장 복제 시 필요한 아티팩트만 선택적으로 복사 가능하다.

### 8. 미결 과제 / 다음 단계
1. 프리셋 목록과 필요한 패키지 버전을 구체화한다.
2. 운영팀이 수용 가능한 아티팩트 폴더 구조를 확정한다.
3. FFmpeg/OpenCV를 미리 빌드해 배포할지, 현장에서 빌드할지 결정한다.
4. 아티팩트 복사 시 체크섬/검증 정책을 수립한다.
